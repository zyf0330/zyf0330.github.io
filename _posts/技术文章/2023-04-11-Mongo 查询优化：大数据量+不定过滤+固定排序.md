---
layout: post
title: 'Mongo 查询优化：大数据量+不定过滤+固定排序.md'
date: 2023-04-11
category: 技术文章
---

# 背景

最近 Access 的同步记录日志查询会报错，错误是排序超出内存限制，错误信息大致是这样：

> message:Executor error during find command :: caused by :: Sort exceeded memory limit of 104857600 bytes, but did not opt in to external sorting. Aborting operation. Pass allowDiskUse:true to opt in.,stack:MongoServerError: Executor error during find command :: caused by :: Sort excee

这个错误大家应该很熟悉，不过还是介绍一下。

# Mongo 的排序方式

> 参考  [https://docs.mongodb.com/manual/reference/explain-results/#sort-stage](https://docs.mongodb.com/manual/reference/explain-results/#sort-stage)  

> 以下 **所有** 数据指的是过滤后的数据

Mongo 的排序方式一般有两种。最原始的方式，就是将所有数据都加载到内存中，然后在内存中对所有数据进行排序。在这种情况下，Mongo 会限制排序只能使用 100MB 的内存空间，如果超过这次操作就会失败。上面的错误也就是这种情况。

> 可以设置  `allowDiskUse()`  来利用磁盘进行排序，突破内存限制。

而另一种方式就是利用索引来排序。利用索引来排序，事实上是这样的，由于索引中已经有了排序信息，因此加载所有数据时直接加载为排序好的数据。此时如果有额外的过滤条件，会将数据流式地取出并进行过滤，而不会一次加载所有。

> 关于这里提到的流式，可以参照   [https://docs.mongodb.com/manual/reference/explain-results/#mongodb-data-explain.executionStats.executionStages.isEOF](https://docs.mongodb.com/manual/reference/explain-results/#mongodb-data-explain.executionStats.executionStages.isEOF)  

> 关于利用索引排序，大家可以参考[如何利用好 MongoDB 复合索引 Combound Index](如何利用好%20MongoDB%20复合索引%20Combound%20Index.md)，其中提到如何利用复合索引来支持排序。


显而易见，前一种方式需要占用和所有数据大小等量的内存，而后一种方式只会占用少量的内存，但要求对排序字段建立索引。

# 要如何创建索引

目前同步记录的查询是由不固定的过滤字段+固定的排序字段组成的：  `find({team: 1, platform: 1, status: 1, created_by?: 1, start_at?: 1}).sort({end_at: 1})`，并且同步记录上是没有索引的。考虑如果使用   `allowDiskUse`  会拖慢这个查询速度，并且随着数据量变大情况会更坏，不是长久之计，因此还是通过建索引的方式来解决。

那么，想当然的，我们可能会想到直接建立复合索引，涵盖过滤字段和排序字段，一举两得。那么，就要考虑索引要包含哪些字段。这里有2个可选的过滤字段和1个固定的排序字段，因此就得建立4个复合索引，才能涵盖这个查询的所有情况。但是，要知道复合索引会占据大量的内存空间，而且这个查询也不是什么关键业务，因此这个索引方案也不是很可取。

那么就剩下一种方案了，只为排序字段建立索引。这听起来似乎很新鲜，因为当我们提起索引，总是首先联想到要对过滤阶段的查询提速。而这里我们竟然要建立一个不涵盖过滤字段的索引，它真的会有效吗？

让我们先来思维论证一下。一个   `{ end_at: 1 }`  的单字段索引，当它被利用到时，意味着数据会先按照顺序加载到内存，然后逐个进行过滤，直到 skip + limit 个，然后取 limit 个。这里有个问题，数据会全部被加载到内存中吗？答案是不会，数据会按顺序流式的加载到内存并进行过滤。

我们用解释查询计划来验证一下。

# 通过 explain 验证

> 这里就不验证无索引和复合索引的情况，这两者结果都是很清晰的。如果有兴趣可以自行验证。

## 单字段排序索引

这里验证单排序字段的索引是否能起到作用。

这里有两个语句的 explain，第二个指定了 skip。数据量是22189。

> 注意里面的   `totalDataSizeSorted`  字段，代表需要进行排序的数据占用的空间，毫无疑问是在内存中占用的。除了那些使用索引排序作为第一阶段的计划外，其他都有这个字段。

`db.synchronization_log.find({team: ObjectId("5db7a0ed77c86b2d749605ad"), platform: 10, status: 1, }).sort({end_at: 1}).limit(50).explain('allPlansExecution')`  

```
pc-alpha> db.synchronization_log.find({team: ObjectId("5db7a0ed77c86b2d749605ad"), platform: 10, status: 1, }).sort({end_at: 1}).limit(50).explain('allPlansExecution')
{
  queryPlanner: {
    plannerVersion: 1,
    namespace: 'pc-alpha.synchronization_log',
    indexFilterSet: false,
    parsedQuery: {
      '$and': [
        { platform: { '$eq': 10 } },
        { status: { '$eq': 1 } },
        { team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") } }
      ]
    },
    winningPlan: {
      stage: 'LIMIT',
      limitAmount: 50,
      inputStage: {
        stage: 'FETCH',
        filter: {
          '$and': [
            { platform: { '$eq': 10 } },
            { status: { '$eq': 1 } },
            { team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") } }
          ]
        },
        inputStage: {
          stage: 'IXSCAN',
          keyPattern: { end_at: 1 },
          indexName: 'end_at_1',
          isMultiKey: false,
          multiKeyPaths: { end_at: [] },
          isUnique: false,
          isSparse: false,
          isPartial: false,
          indexVersion: 2,
          direction: 'forward',
          indexBounds: { end_at: [ '[MinKey, MaxKey]' ] }
        }
      }
    },
    rejectedPlans: [
      {
        stage: 'SORT',
        sortPattern: { end_at: 1 },
        memLimit: 104857600,
        limitAmount: 50,
        type: 'simple',
        inputStage: {
          stage: 'FETCH',
          filter: {
            '$and': [ { platform: { '$eq': 10 } }, { status: { '$eq': 1 } } ]
          },
          inputStage: {
            stage: 'IXSCAN',
            keyPattern: { team: 1 },
            indexName: 'team_1',
            isMultiKey: false,
            multiKeyPaths: { team: [] },
            isUnique: false,
            isSparse: false,
            isPartial: false,
            indexVersion: 2,
            direction: 'forward',
            indexBounds: {
              team: [
                "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
              ]
            }
          }
        }
      },
      {
        stage: 'SORT',
        sortPattern: { end_at: 1 },
        memLimit: 104857600,
        limitAmount: 50,
        type: 'simple',
        inputStage: {
          stage: 'FETCH',
          filter: { status: { '$eq': 1 } },
          inputStage: {
            stage: 'IXSCAN',
            keyPattern: { team: 1, platform: 1 },
            indexName: 'team_1_platform_1',
            isMultiKey: false,
            multiKeyPaths: { team: [], platform: [] },
            isUnique: false,
            isSparse: false,
            isPartial: false,
            indexVersion: 2,
            direction: 'forward',
            indexBounds: {
              team: [
                "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
              ],
              platform: [ '[10, 10]' ]
            }
          }
        }
      }
    ]
  },
  executionStats: {
    executionSuccess: true,
    nReturned: 50,
    executionTimeMillis: 4,
    totalKeysExamined: 632,
    totalDocsExamined: 632,
    executionStages: {
      stage: 'LIMIT',
      nReturned: 50,
      executionTimeMillisEstimate: 0,
      works: 633,
      advanced: 50,
      needTime: 582,
      needYield: 0,
      saveState: 1,
      restoreState: 1,
      isEOF: 1,
      limitAmount: 50,
      inputStage: {
        stage: 'FETCH',
        filter: {
          '$and': [
            { platform: { '$eq': 10 } },
            { status: { '$eq': 1 } },
            { team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") } }
          ]
        },
        nReturned: 50,
        executionTimeMillisEstimate: 0,
        works: 632,
        advanced: 50,
        needTime: 582,
        needYield: 0,
        saveState: 1,
        restoreState: 1,
        isEOF: 0,
        docsExamined: 632,
        alreadyHasObj: 0,
        inputStage: {
          stage: 'IXSCAN',
          nReturned: 632,
          executionTimeMillisEstimate: 0,
          works: 632,
          advanced: 632,
          needTime: 0,
          needYield: 0,
          saveState: 1,
          restoreState: 1,
          isEOF: 0,
          keyPattern: { end_at: 1 },
          indexName: 'end_at_1',
          isMultiKey: false,
          multiKeyPaths: { end_at: [] },
          isUnique: false,
          isSparse: false,
          isPartial: false,
          indexVersion: 2,
          direction: 'forward',
          indexBounds: { end_at: [ '[MinKey, MaxKey]' ] },
          keysExamined: 632,
          seeks: 1,
          dupsTested: 0,
          dupsDropped: 0
        }
      }
    },
    allPlansExecution: [
      {
        nReturned: 50,
        executionTimeMillisEstimate: 0,
        totalKeysExamined: 632,
        totalDocsExamined: 632,
        executionStages: {
          stage: 'LIMIT',
          nReturned: 50,
          executionTimeMillisEstimate: 0,
          works: 632,
          advanced: 50,
          needTime: 582,
          needYield: 0,
          saveState: 1,
          restoreState: 1,
          isEOF: 1,
          limitAmount: 50,
          inputStage: {
            stage: 'FETCH',
            filter: {
              '$and': [
                { platform: { '$eq': 10 } },
                { status: { '$eq': 1 } },
                {
                  team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") }
                }
              ]
            },
            nReturned: 50,
            executionTimeMillisEstimate: 0,
            works: 632,
            advanced: 50,
            needTime: 582,
            needYield: 0,
            saveState: 1,
            restoreState: 1,
            isEOF: 0,
            docsExamined: 632,
            alreadyHasObj: 0,
            inputStage: {
              stage: 'IXSCAN',
              nReturned: 632,
              executionTimeMillisEstimate: 0,
              works: 632,
              advanced: 632,
              needTime: 0,
              needYield: 0,
              saveState: 1,
              restoreState: 1,
              isEOF: 0,
              keyPattern: { end_at: 1 },
              indexName: 'end_at_1',
              isMultiKey: false,
              multiKeyPaths: { end_at: [] },
              isUnique: false,
              isSparse: false,
              isPartial: false,
              indexVersion: 2,
              direction: 'forward',
              indexBounds: { end_at: [ '[MinKey, MaxKey]' ] },
              keysExamined: 632,
              seeks: 1,
              dupsTested: 0,
              dupsDropped: 0
            }
          }
        }
      },
      {
        nReturned: 0,
        executionTimeMillisEstimate: 0,
        totalKeysExamined: 632,
        totalDocsExamined: 632,
        executionStages: {
          stage: 'SORT',
          nReturned: 0,
          executionTimeMillisEstimate: 0,
          works: 632,
          advanced: 0,
          needTime: 632,
          needYield: 0,
          saveState: 1,
          restoreState: 1,
          isEOF: 0,
          sortPattern: { end_at: 1 },
          memLimit: 104857600,
          limitAmount: 50,
          type: 'simple',
          totalDataSizeSorted: 43967,
          usedDisk: false,
          inputStage: {
            stage: 'FETCH',
            filter: {
              '$and': [ { platform: { '$eq': 10 } }, { status: { '$eq': 1 } } ]
            },
            nReturned: 77,
            executionTimeMillisEstimate: 0,
            works: 632,
            advanced: 77,
            needTime: 555,
            needYield: 0,
            saveState: 1,
            restoreState: 1,
            isEOF: 0,
            docsExamined: 632,
            alreadyHasObj: 0,
            inputStage: {
              stage: 'IXSCAN',
              nReturned: 632,
              executionTimeMillisEstimate: 0,
              works: 632,
              advanced: 632,
              needTime: 0,
              needYield: 0,
              saveState: 1,
              restoreState: 1,
              isEOF: 0,
              keyPattern: { team: 1 },
              indexName: 'team_1',
              isMultiKey: false,
              multiKeyPaths: { team: [] },
              isUnique: false,
              isSparse: false,
              isPartial: false,
              indexVersion: 2,
              direction: 'forward',
              indexBounds: {
                team: [
                  "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
                ]
              },
              keysExamined: 632,
              seeks: 1,
              dupsTested: 0,
              dupsDropped: 0
            }
          }
        }
      },
      {
        nReturned: 0,
        executionTimeMillisEstimate: 0,
        totalKeysExamined: 632,
        totalDocsExamined: 632,
        executionStages: {
          stage: 'SORT',
          nReturned: 0,
          executionTimeMillisEstimate: 0,
          works: 632,
          advanced: 0,
          needTime: 632,
          needYield: 0,
          saveState: 1,
          restoreState: 1,
          isEOF: 0,
          sortPattern: { end_at: 1 },
          memLimit: 104857600,
          limitAmount: 50,
          type: 'simple',
          totalDataSizeSorted: 360872,
          usedDisk: false,
          inputStage: {
            stage: 'FETCH',
            filter: { status: { '$eq': 1 } },
            nReturned: 632,
            executionTimeMillisEstimate: 0,
            works: 632,
            advanced: 632,
            needTime: 0,
            needYield: 0,
            saveState: 1,
            restoreState: 1,
            isEOF: 0,
            docsExamined: 632,
            alreadyHasObj: 0,
            inputStage: {
              stage: 'IXSCAN',
              nReturned: 632,
              executionTimeMillisEstimate: 0,
              works: 632,
              advanced: 632,
              needTime: 0,
              needYield: 0,
              saveState: 1,
              restoreState: 1,
              isEOF: 0,
              keyPattern: { team: 1, platform: 1 },
              indexName: 'team_1_platform_1',
              isMultiKey: false,
              multiKeyPaths: { team: [], platform: [] },
              isUnique: false,
              isSparse: false,
              isPartial: false,
              indexVersion: 2,
              direction: 'forward',
              indexBounds: {
                team: [
                  "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
                ],
                platform: [ '[10, 10]' ]
              },
              keysExamined: 632,
              seeks: 1,
              dupsTested: 0,
              dupsDropped: 0
            }
          }
        }
      }
    ]
  },
  serverInfo: {
    host: 'yc-dev-other-01-ningxia',
    port: 10000,
    version: '4.4.9',
    gitVersion: 'b4048e19814bfebac717cf5a880076aa69aba481'
  },
  ok: 1
}

```

`db.synchronization_log.find({team: ObjectId("5db7a0ed77c86b2d749605ad"), platform: 10, status: 1, }).sort({end_at: 1}).skip(7000).limit(50).explain('allPlansExecution')`   

```
pc-alpha> db.synchronization_log.find({team: ObjectId("5db7a0ed77c86b2d749605ad"), platform: 10, status: 1, }).sort({end_at: 1}).skip(7000).limit(50).explain('allPlansExecution')
{
  queryPlanner: {
    plannerVersion: 1,
    namespace: 'pc-alpha.synchronization_log',
    indexFilterSet: false,
    parsedQuery: {
      '$and': [
        { platform: { '$eq': 10 } },
        { status: { '$eq': 1 } },
        { team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") } }
      ]
    },
    winningPlan: {
      stage: 'LIMIT',
      limitAmount: 50,
      inputStage: {
        stage: 'SKIP',
        skipAmount: 0,
        inputStage: {
          stage: 'FETCH',
          filter: {
            '$and': [
              { platform: { '$eq': 10 } },
              { status: { '$eq': 1 } },
              { team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") } }
            ]
          },
          inputStage: {
            stage: 'IXSCAN',
            keyPattern: { end_at: 1 },
            indexName: 'end_at_1',
            isMultiKey: false,
            multiKeyPaths: { end_at: [] },
            isUnique: false,
            isSparse: false,
            isPartial: false,
            indexVersion: 2,
            direction: 'forward',
            indexBounds: { end_at: [ '[MinKey, MaxKey]' ] }
          }
        }
      }
    },
    rejectedPlans: [
      {
        stage: 'SKIP',
        skipAmount: 7000,
        inputStage: {
          stage: 'SORT',
          sortPattern: { end_at: 1 },
          memLimit: 104857600,
          limitAmount: 7050,
          type: 'simple',
          inputStage: {
            stage: 'FETCH',
            filter: {
              '$and': [ { platform: { '$eq': 10 } }, { status: { '$eq': 1 } } ]
            },
            inputStage: {
              stage: 'IXSCAN',
              keyPattern: { team: 1 },
              indexName: 'team_1',
              isMultiKey: false,
              multiKeyPaths: { team: [] },
              isUnique: false,
              isSparse: false,
              isPartial: false,
              indexVersion: 2,
              direction: 'forward',
              indexBounds: {
                team: [
                  "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
                ]
              }
            }
          }
        }
      },
      {
        stage: 'SKIP',
        skipAmount: 7000,
        inputStage: {
          stage: 'SORT',
          sortPattern: { end_at: 1 },
          memLimit: 104857600,
          limitAmount: 7050,
          type: 'simple',
          inputStage: {
            stage: 'FETCH',
            filter: { status: { '$eq': 1 } },
            inputStage: {
              stage: 'IXSCAN',
              keyPattern: { team: 1, platform: 1 },
              indexName: 'team_1_platform_1',
              isMultiKey: false,
              multiKeyPaths: { team: [], platform: [] },
              isUnique: false,
              isSparse: false,
              isPartial: false,
              indexVersion: 2,
              direction: 'forward',
              indexBounds: {
                team: [
                  "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
                ],
                platform: [ '[10, 10]' ]
              }
            }
          }
        }
      }
    ]
  },
  executionStats: {
    executionSuccess: true,
    nReturned: 50,
    executionTimeMillis: 63,
    totalKeysExamined: 7634,
    totalDocsExamined: 7634,
    executionStages: {
      stage: 'LIMIT',
      nReturned: 50,
      executionTimeMillisEstimate: 4,
      works: 7635,
      advanced: 50,
      needTime: 7584,
      needYield: 0,
      saveState: 22,
      restoreState: 22,
      isEOF: 1,
      limitAmount: 50,
      inputStage: {
        stage: 'SKIP',
        nReturned: 50,
        executionTimeMillisEstimate: 4,
        works: 7634,
        advanced: 50,
        needTime: 7584,
        needYield: 0,
        saveState: 22,
        restoreState: 22,
        isEOF: 0,
        skipAmount: 0,
        inputStage: {
          stage: 'FETCH',
          filter: {
            '$and': [
              { platform: { '$eq': 10 } },
              { status: { '$eq': 1 } },
              { team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") } }
            ]
          },
          nReturned: 7050,
          executionTimeMillisEstimate: 4,
          works: 7634,
          advanced: 7050,
          needTime: 584,
          needYield: 0,
          saveState: 22,
          restoreState: 22,
          isEOF: 0,
          docsExamined: 7634,
          alreadyHasObj: 0,
          inputStage: {
            stage: 'IXSCAN',
            nReturned: 7634,
            executionTimeMillisEstimate: 3,
            works: 7634,
            advanced: 7634,
            needTime: 0,
            needYield: 0,
            saveState: 22,
            restoreState: 22,
            isEOF: 0,
            keyPattern: { end_at: 1 },
            indexName: 'end_at_1',
            isMultiKey: false,
            multiKeyPaths: { end_at: [] },
            isUnique: false,
            isSparse: false,
            isPartial: false,
            indexVersion: 2,
            direction: 'forward',
            indexBounds: { end_at: [ '[MinKey, MaxKey]' ] },
            keysExamined: 7634,
            seeks: 1,
            dupsTested: 0,
            dupsDropped: 0
          }
        }
      }
    },
    allPlansExecution: [
      {
        nReturned: 50,
        executionTimeMillisEstimate: 4,
        totalKeysExamined: 7634,
        totalDocsExamined: 7634,
        executionStages: {
          stage: 'LIMIT',
          nReturned: 50,
          executionTimeMillisEstimate: 4,
          works: 7634,
          advanced: 50,
          needTime: 7584,
          needYield: 0,
          saveState: 22,
          restoreState: 22,
          isEOF: 1,
          limitAmount: 50,
          inputStage: {
            stage: 'SKIP',
            nReturned: 50,
            executionTimeMillisEstimate: 4,
            works: 7634,
            advanced: 50,
            needTime: 7584,
            needYield: 0,
            saveState: 22,
            restoreState: 22,
            isEOF: 0,
            skipAmount: 0,
            inputStage: {
              stage: 'FETCH',
              filter: {
                '$and': [
                  { platform: { '$eq': 10 } },
                  { status: { '$eq': 1 } },
                  {
                    team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") }
                  }
                ]
              },
              nReturned: 7050,
              executionTimeMillisEstimate: 4,
              works: 7634,
              advanced: 7050,
              needTime: 584,
              needYield: 0,
              saveState: 22,
              restoreState: 22,
              isEOF: 0,
              docsExamined: 7634,
              alreadyHasObj: 0,
              inputStage: {
                stage: 'IXSCAN',
                nReturned: 7634,
                executionTimeMillisEstimate: 3,
                works: 7634,
                advanced: 7634,
                needTime: 0,
                needYield: 0,
                saveState: 22,
                restoreState: 22,
                isEOF: 0,
                keyPattern: { end_at: 1 },
                indexName: 'end_at_1',
                isMultiKey: false,
                multiKeyPaths: { end_at: [] },
                isUnique: false,
                isSparse: false,
                isPartial: false,
                indexVersion: 2,
                direction: 'forward',
                indexBounds: { end_at: [ '[MinKey, MaxKey]' ] },
                keysExamined: 7634,
                seeks: 1,
                dupsTested: 0,
                dupsDropped: 0
              }
            }
          }
        }
      },
      {
        nReturned: 0,
        executionTimeMillisEstimate: 1,
        totalKeysExamined: 7634,
        totalDocsExamined: 7634,
        executionStages: {
          stage: 'SKIP',
          nReturned: 0,
          executionTimeMillisEstimate: 1,
          works: 7634,
          advanced: 0,
          needTime: 7634,
          needYield: 0,
          saveState: 22,
          restoreState: 22,
          isEOF: 0,
          skipAmount: 7000,
          inputStage: {
            stage: 'SORT',
            nReturned: 0,
            executionTimeMillisEstimate: 1,
            works: 7634,
            advanced: 0,
            needTime: 7634,
            needYield: 0,
            saveState: 22,
            restoreState: 22,
            isEOF: 0,
            sortPattern: { end_at: 1 },
            memLimit: 104857600,
            limitAmount: 7050,
            type: 'simple',
            totalDataSizeSorted: 4042109,
            usedDisk: false,
            inputStage: {
              stage: 'FETCH',
              filter: {
                '$and': [
                  { platform: { '$eq': 10 } },
                  { status: { '$eq': 1 } }
                ]
              },
              nReturned: 7079,
              executionTimeMillisEstimate: 1,
              works: 7634,
              advanced: 7079,
              needTime: 555,
              needYield: 0,
              saveState: 22,
              restoreState: 22,
              isEOF: 0,
              docsExamined: 7634,
              alreadyHasObj: 0,
              inputStage: {
                stage: 'IXSCAN',
                nReturned: 7634,
                executionTimeMillisEstimate: 1,
                works: 7634,
                advanced: 7634,
                needTime: 0,
                needYield: 0,
                saveState: 22,
                restoreState: 22,
                isEOF: 0,
                keyPattern: { team: 1 },
                indexName: 'team_1',
                isMultiKey: false,
                multiKeyPaths: { team: [] },
                isUnique: false,
                isSparse: false,
                isPartial: false,
                indexVersion: 2,
                direction: 'forward',
                indexBounds: {
                  team: [
                    "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
                  ]
                },
                keysExamined: 7634,
                seeks: 1,
                dupsTested: 0,
                dupsDropped: 0
              }
            }
          }
        }
      },
      {
        nReturned: 0,
        executionTimeMillisEstimate: 1,
        totalKeysExamined: 7634,
        totalDocsExamined: 7634,
        executionStages: {
          stage: 'SKIP',
          nReturned: 0,
          executionTimeMillisEstimate: 1,
          works: 7634,
          advanced: 0,
          needTime: 7634,
          needYield: 0,
          saveState: 22,
          restoreState: 22,
          isEOF: 0,
          skipAmount: 7000,
          inputStage: {
            stage: 'SORT',
            nReturned: 0,
            executionTimeMillisEstimate: 1,
            works: 7634,
            advanced: 0,
            needTime: 7634,
            needYield: 0,
            saveState: 22,
            restoreState: 22,
            isEOF: 0,
            sortPattern: { end_at: 1 },
            memLimit: 104857600,
            limitAmount: 7050,
            type: 'simple',
            totalDataSizeSorted: 4359014,
            usedDisk: false,
            inputStage: {
              stage: 'FETCH',
              filter: { status: { '$eq': 1 } },
              nReturned: 7634,
              executionTimeMillisEstimate: 1,
              works: 7634,
              advanced: 7634,
              needTime: 0,
              needYield: 0,
              saveState: 22,
              restoreState: 22,
              isEOF: 0,
              docsExamined: 7634,
              alreadyHasObj: 0,
              inputStage: {
                stage: 'IXSCAN',
                nReturned: 7634,
                executionTimeMillisEstimate: 1,
                works: 7634,
                advanced: 7634,
                needTime: 0,
                needYield: 0,
                saveState: 22,
                restoreState: 22,
                isEOF: 0,
                keyPattern: { team: 1, platform: 1 },
                indexName: 'team_1_platform_1',
                isMultiKey: false,
                multiKeyPaths: { team: [], platform: [] },
                isUnique: false,
                isSparse: false,
                isPartial: false,
                indexVersion: 2,
                direction: 'forward',
                indexBounds: {
                  team: [
                    "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
                  ],
                  platform: [ '[10, 10]' ]
                },
                keysExamined: 7634,
                seeks: 1,
                dupsTested: 0,
                dupsDropped: 0
              }
            }
          }
        }
      }
    ]
  },
  serverInfo: {
    host: 'yc-dev-other-01-ningxia',
    port: 10000,
    version: '4.4.9',
    gitVersion: 'b4048e19814bfebac717cf5a880076aa69aba481'
  },
  ok: 1
}

```

可以看到，单排序字段索引在两种情况下都全胜。而其他的查询计划都要占用大量的内存空间来进行排序。但是前者执行速度不是最优的。这些都符合思维论证。

再重新逐阶段描述一下，利用单排序字段索引进行查询的过程：

1. `IXSCAN`   阶段使用   `end_at`   索引获取排序好的数据
1. `FETCH`   阶段，对上一阶段流进来的数据进行过滤
1. `SKIP`   阶段，对上一阶段的数据进行跳过直到 skip 数量
1. `LIMIT`   阶段，对上一阶段的数据进行截取直到 limit 数量




## 和完全匹配复合索引比较

这里我们再创建一个完全复合过滤条件的复合索引   `{ team: 1, platform: 1 }`  ，来比一比它是否能胜过单排序字段索引。

查询语句  `db.synchronization_log.find({team: ObjectId("5db7a0ed77c86b2d749605ad"), platform: 10 }).sort({end_at: 1}).skip(7000).limit(50).explain('allPlansExecution')`   

然而，获胜计划依旧是单字段排序索引。复合索引依旧会消耗大量内存空间   `totalDataSizeSorted`  用于排序。

```
pc-alpha> db.synchronization_log.find({team: ObjectId("5db7a0ed77c86b2d749605ad"), platform: 10 }).sort({end_at: 1}).skip(7000).limit(50).explain('allPlansExecution')
{
  queryPlanner: {
    plannerVersion: 1,
    namespace: 'pc-alpha.synchronization_log',
    indexFilterSet: false,
    parsedQuery: {
      '$and': [
        { platform: { '$eq': 10 } },
        { team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") } }
      ]
    },
    winningPlan: {
      stage: 'LIMIT',
      limitAmount: 50,
      inputStage: {
        stage: 'SKIP',
        skipAmount: 0,
        inputStage: {
          stage: 'FETCH',
          filter: {
            '$and': [
              { platform: { '$eq': 10 } },
              { team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") } }
            ]
          },
          inputStage: {
            stage: 'IXSCAN',
            keyPattern: { end_at: 1 },
            indexName: 'end_at_1',
            isMultiKey: false,
            multiKeyPaths: { end_at: [] },
            isUnique: false,
            isSparse: false,
            isPartial: false,
            indexVersion: 2,
            direction: 'forward',
            indexBounds: { end_at: [ '[MinKey, MaxKey]' ] }
          }
        }
      }
    },
    rejectedPlans: [
      {
        stage: 'SKIP',
        skipAmount: 7000,
        inputStage: {
          stage: 'SORT',
          sortPattern: { end_at: 1 },
          memLimit: 104857600,
          limitAmount: 7050,
          type: 'simple',
          inputStage: {
            stage: 'FETCH',
            filter: { platform: { '$eq': 10 } },
            inputStage: {
              stage: 'IXSCAN',
              keyPattern: { team: 1 },
              indexName: 'team_1',
              isMultiKey: false,
              multiKeyPaths: { team: [] },
              isUnique: false,
              isSparse: false,
              isPartial: false,
              indexVersion: 2,
              direction: 'forward',
              indexBounds: {
                team: [
                  "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
                ]
              }
            }
          }
        }
      },
      {
        stage: 'SKIP',
        skipAmount: 7000,
        inputStage: {
          stage: 'SORT',
          sortPattern: { end_at: 1 },
          memLimit: 104857600,
          limitAmount: 7050,
          type: 'simple',
          inputStage: {
            stage: 'FETCH',
            inputStage: {
              stage: 'IXSCAN',
              keyPattern: { team: 1, platform: 1 },
              indexName: 'team_1_platform_1',
              isMultiKey: false,
              multiKeyPaths: { team: [], platform: [] },
              isUnique: false,
              isSparse: false,
              isPartial: false,
              indexVersion: 2,
              direction: 'forward',
              indexBounds: {
                team: [
                  "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
                ],
                platform: [ '[10, 10]' ]
              }
            }
          }
        }
      }
    ]
  },
  executionStats: {
    executionSuccess: true,
    nReturned: 50,
    executionTimeMillis: 252,
    totalKeysExamined: 7634,
    totalDocsExamined: 7634,
    executionStages: {
      stage: 'LIMIT',
      nReturned: 50,
      executionTimeMillisEstimate: 39,
      works: 7635,
      advanced: 50,
      needTime: 7584,
      needYield: 0,
      saveState: 25,
      restoreState: 25,
      isEOF: 1,
      limitAmount: 50,
      inputStage: {
        stage: 'SKIP',
        nReturned: 50,
        executionTimeMillisEstimate: 39,
        works: 7634,
        advanced: 50,
        needTime: 7584,
        needYield: 0,
        saveState: 25,
        restoreState: 25,
        isEOF: 0,
        skipAmount: 0,
        inputStage: {
          stage: 'FETCH',
          filter: {
            '$and': [
              { platform: { '$eq': 10 } },
              { team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") } }
            ]
          },
          nReturned: 7050,
          executionTimeMillisEstimate: 39,
          works: 7634,
          advanced: 7050,
          needTime: 584,
          needYield: 0,
          saveState: 25,
          restoreState: 25,
          isEOF: 0,
          docsExamined: 7634,
          alreadyHasObj: 0,
          inputStage: {
            stage: 'IXSCAN',
            nReturned: 7634,
            executionTimeMillisEstimate: 4,
            works: 7634,
            advanced: 7634,
            needTime: 0,
            needYield: 0,
            saveState: 25,
            restoreState: 25,
            isEOF: 0,
            keyPattern: { end_at: 1 },
            indexName: 'end_at_1',
            isMultiKey: false,
            multiKeyPaths: { end_at: [] },
            isUnique: false,
            isSparse: false,
            isPartial: false,
            indexVersion: 2,
            direction: 'forward',
            indexBounds: { end_at: [ '[MinKey, MaxKey]' ] },
            keysExamined: 7634,
            seeks: 1,
            dupsTested: 0,
            dupsDropped: 0
          }
        }
      }
    },
    allPlansExecution: [
      {
        nReturned: 50,
        executionTimeMillisEstimate: 39,
        totalKeysExamined: 7634,
        totalDocsExamined: 7634,
        executionStages: {
          stage: 'LIMIT',
          nReturned: 50,
          executionTimeMillisEstimate: 39,
          works: 7634,
          advanced: 50,
          needTime: 7584,
          needYield: 0,
          saveState: 25,
          restoreState: 25,
          isEOF: 1,
          limitAmount: 50,
          inputStage: {
            stage: 'SKIP',
            nReturned: 50,
            executionTimeMillisEstimate: 39,
            works: 7634,
            advanced: 50,
            needTime: 7584,
            needYield: 0,
            saveState: 25,
            restoreState: 25,
            isEOF: 0,
            skipAmount: 0,
            inputStage: {
              stage: 'FETCH',
              filter: {
                '$and': [
                  { platform: { '$eq': 10 } },
                  {
                    team: { '$eq': ObjectId("5db7a0ed77c86b2d749605ad") }
                  }
                ]
              },
              nReturned: 7050,
              executionTimeMillisEstimate: 39,
              works: 7634,
              advanced: 7050,
              needTime: 584,
              needYield: 0,
              saveState: 25,
              restoreState: 25,
              isEOF: 0,
              docsExamined: 7634,
              alreadyHasObj: 0,
              inputStage: {
                stage: 'IXSCAN',
                nReturned: 7634,
                executionTimeMillisEstimate: 4,
                works: 7634,
                advanced: 7634,
                needTime: 0,
                needYield: 0,
                saveState: 25,
                restoreState: 25,
                isEOF: 0,
                keyPattern: { end_at: 1 },
                indexName: 'end_at_1',
                isMultiKey: false,
                multiKeyPaths: { end_at: [] },
                isUnique: false,
                isSparse: false,
                isPartial: false,
                indexVersion: 2,
                direction: 'forward',
                indexBounds: { end_at: [ '[MinKey, MaxKey]' ] },
                keysExamined: 7634,
                seeks: 1,
                dupsTested: 0,
                dupsDropped: 0
              }
            }
          }
        }
      },
      {
        nReturned: 0,
        executionTimeMillisEstimate: 72,
        totalKeysExamined: 7634,
        totalDocsExamined: 7634,
        executionStages: {
          stage: 'SKIP',
          nReturned: 0,
          executionTimeMillisEstimate: 72,
          works: 7634,
          advanced: 0,
          needTime: 7634,
          needYield: 0,
          saveState: 25,
          restoreState: 25,
          isEOF: 0,
          skipAmount: 7000,
          inputStage: {
            stage: 'SORT',
            nReturned: 0,
            executionTimeMillisEstimate: 72,
            works: 7634,
            advanced: 0,
            needTime: 7634,
            needYield: 0,
            saveState: 25,
            restoreState: 25,
            isEOF: 0,
            sortPattern: { end_at: 1 },
            memLimit: 104857600,
            limitAmount: 7050,
            type: 'simple',
            totalDataSizeSorted: 4042109,
            usedDisk: false,
            inputStage: {
              stage: 'FETCH',
              filter: { platform: { '$eq': 10 } },
              nReturned: 7079,
              executionTimeMillisEstimate: 54,
              works: 7634,
              advanced: 7079,
              needTime: 555,
              needYield: 0,
              saveState: 25,
              restoreState: 25,
              isEOF: 0,
              docsExamined: 7634,
              alreadyHasObj: 0,
              inputStage: {
                stage: 'IXSCAN',
                nReturned: 7634,
                executionTimeMillisEstimate: 44,
                works: 7634,
                advanced: 7634,
                needTime: 0,
                needYield: 0,
                saveState: 25,
                restoreState: 25,
                isEOF: 0,
                keyPattern: { team: 1 },
                indexName: 'team_1',
                isMultiKey: false,
                multiKeyPaths: { team: [] },
                isUnique: false,
                isSparse: false,
                isPartial: false,
                indexVersion: 2,
                direction: 'forward',
                indexBounds: {
                  team: [
                    "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
                  ]
                },
                keysExamined: 7634,
                seeks: 1,
                dupsTested: 0,
                dupsDropped: 0
              }
            }
          }
        }
      },
      {
        nReturned: 0,
        executionTimeMillisEstimate: 68,
        totalKeysExamined: 7634,
        totalDocsExamined: 7634,
        executionStages: {
          stage: 'SKIP',
          nReturned: 0,
          executionTimeMillisEstimate: 68,
          works: 7634,
          advanced: 0,
          needTime: 7634,
          needYield: 0,
          saveState: 25,
          restoreState: 25,
          isEOF: 0,
          skipAmount: 7000,
          inputStage: {
            stage: 'SORT',
            nReturned: 0,
            executionTimeMillisEstimate: 57,
            works: 7634,
            advanced: 0,
            needTime: 7634,
            needYield: 0,
            saveState: 25,
            restoreState: 25,
            isEOF: 0,
            sortPattern: { end_at: 1 },
            memLimit: 104857600,
            limitAmount: 7050,
            type: 'simple',
            totalDataSizeSorted: 4359014,
            usedDisk: false,
            inputStage: {
              stage: 'FETCH',
              nReturned: 7634,
              executionTimeMillisEstimate: 52,
              works: 7634,
              advanced: 7634,
              needTime: 0,
              needYield: 0,
              saveState: 25,
              restoreState: 25,
              isEOF: 0,
              docsExamined: 7634,
              alreadyHasObj: 0,
              inputStage: {
                stage: 'IXSCAN',
                nReturned: 7634,
                executionTimeMillisEstimate: 24,
                works: 7634,
                advanced: 7634,
                needTime: 0,
                needYield: 0,
                saveState: 25,
                restoreState: 25,
                isEOF: 0,
                keyPattern: { team: 1, platform: 1 },
                indexName: 'team_1_platform_1',
                isMultiKey: false,
                multiKeyPaths: { team: [], platform: [] },
                isUnique: false,
                isSparse: false,
                isPartial: false,
                indexVersion: 2,
                direction: 'forward',
                indexBounds: {
                  team: [
                    "[ObjectId('5db7a0ed77c86b2d749605ad'), ObjectId('5db7a0ed77c86b2d749605ad')]"
                  ],
                  platform: [ '[10, 10]' ]
                },
                keysExamined: 7634,
                seeks: 1,
                dupsTested: 0,
                dupsDropped: 0
              }
            }
          }
        }
      }
    ]
  },
  serverInfo: {
    host: 'yc-dev-other-01-ningxia',
    port: 10000,
    version: '4.4.9',
    gitVersion: 'b4048e19814bfebac717cf5a880076aa69aba481'
  },
  ok: 1
}

```

# 结论

经过一系列论证，最终决定使用单排序字段索引来解决同步记录查询失败的问题，并且这个手段的性能平衡了各种情况：

1. 毫无疑问它比不建立索引要快得多，并且占用内存也少得多，代价是创建索引消耗一些空间
1. 它比复合索引慢一些，但需要的索引空间相比要少很多

再抽象一下这个业务场景，如标题所述，我给出结论：  
  **对于数据量大、过滤条件字段多且不定、排序条件字段固定且组合不多的查询，如果对于查询速度要求不高，那么只为排序字段建立索引，会有更好的综合性能。**    

