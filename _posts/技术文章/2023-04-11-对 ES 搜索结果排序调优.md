---
layout: post
title: '对 ES 搜索结果排序调优.md'
date: 2023-04-11
category: 技术文章
---

# 背景

PingCode 中，由 Ladon 提供的全文搜索功能十分强大，但是还有一些细节不尽如人意。

其中非常明显的一个，就是排序结果不符合预期。具体问题的表现，可以看下面这张图。
![](../attachments/Pasted%20image%2020240315130506.png)

当搜索  **产品介绍**  这个词组时，匹配其中单个词的结果反而排到了匹配整个词组的结果上面。

针对这个问题，我做了一些排查和搜索，最终找到了办法。  

# 过程

## 检查排序参数

目前的排序参数，是根据分数 score 来排序的。这没什么问题，所以我们接下来要看，如何能提高对应结果的分数。

## 检查评分参数

ES 搜索的评分计算，是由 query 语句来决定的。

我们使用的是  `multi_fields`  来让一条关键词同时对多个字段进行匹配，使用   `type: best_fields`  ，这会将一条数据中匹配度最好的字段的评分作为整条数据在搜索结果中的评分。

这两个配置都没什么问题，和我们的预期相符。

试试  `type: phrase`  ，它会将关键词作为整体来匹配结果，这样的话，就无法搜索到只匹配其中部分词语的结果。这不是我们想要的。

再试试   `operator: AND`  它会搜索出包含  **所有**  关键词分词内容的结果，这样也无法搜索到只匹配其中部分词语的结果。（默认值是   `operator: OR`  ，满足其中一个分词词语即可）。

## 查看官方指南

在查看 ES 文档的过程中，我发现 ES 官方有篇文章，是关于  [如何改善搜索相关度](https://www.elastic.co/cn/blog/how-to-improve-elasticsearch-search-relevance-with-boolean-queries)  的。在查看内容后，我发现  ** Combining OR, AND, and match phrase queries**   这节的内容就是我需要的。

它的原理也比较简单，利用到了上面提到的   `operator`  和   `type`  参数，用同一组关键词对结果分别进行  **全等、全包含、包含部分**  三次匹配，一条结果能匹配到的条件越多，那么得分自然也就越高。

# 结尾

到这里，我们也就解决了这个问题。现在我们能得到和预期更加相符的排序结果——和我们的搜索关键词匹配的最精确排序越靠前。

我们经常会遇到需要对工作中用到的某个技术进行调优或解决问题，在不熟悉该技术的前提下，相比直接查看 API 文档，先查看官方指南或最佳实践，  **面向问题编程**  ，是一种更为快捷有效的手段。

