---
layout: post
title: '解决 NX 中 debug 断点生效不正常的问题.md'
date: 2023-04-11
category: 技术文章
---

上次把 typhon 转成 NX 项目后，一直有一个问题没有得到解决，就是断点不会生效，或者不在正确的源代码行位置生效。这个问题还是很影响开发效率的，因此之后专门找了时间来解决这个问题。

接下来就叙述一下我是如何解决这个问题的。


# Debug 是如何工作的

首先我们了解一下在 Node 中是如何 Debug 的

> 下面描述的是在 IDE 中（比如 VSCode 和 WebStorm）进行断点调试的场景。

node 使用   `--inspect`  标志运行 JS 代码，就会开启 debug 模式，这时我们可以打断点（Breakpoint）。当我们打断点的时候，是可以打在  **某一行或者是某一行的某个函数**  的。当程序运行到这处位置，就会停住，我们可以查看这处位置上下文的信息，包括当前所在的代码位置、从里到外各层级变量的值、线程信息等，甚至还可以在提供的 Debugger Console 中执行 JS 代码来做一些事情，比如调用当前上下文的函数、修改变量等。

> 写 `debugger`  这句代码的作用和打断点相同噢！



# SourceMap 是什么

既然断点有时可以生效，但却是在错误的位置，那么说明我们打的断点打歪了​。但是怎么会打歪呢？

注意到上面说的是 JS 代码，而我们现在是在 TS 代码上打断点的。我们都知道 TS 代码经过编译后变成了 JS 代码。

> 这里将 TS 代码称为源代码，将 JS 代码称为运行代码

这两份代码有同样的逻辑，但有不同的长相。那么怎么能将源代码的断点生效在运行代码的相同逻辑处呢？这里我们就需要 SourceMap 了。

SourceMap 直译过来就是源代码图，map 这个东西，就是建立一种映射关系，所以含义自然是运行代码到源代码的映射。简单说，就是通过 Sourcemap 可以找到某块运行代码对应到的源代码，这个地图可以精确到行和列的映射。

> SourceMap 有三种标准（目前最新的是 v3）和几种形式，这里不一一列举。可以自行相关规范。

# NX 的编译构建过程

> 目前 NX 的编译构建过程包括两部分，通过 tsc 将 TS 按文件编译成 JS，再通过 webpack 将所有 JS 文件打包成一个 JS 文件。

然而在检查过生成的源代码后，发现是有 SourceMap 的，并且经过检查，tsconfig 和 nx 中都已经配了开启 sourceMap。那么难道是生成了错误的 SourceMap？

我们现在需要检查一下 SourceMap 的内容到底对不对。得益于 WebStorm 自带的 SourceMap Visualizer，我能方便地看到生成的 SourceMap 对应的源代码。这个源代码看起来是 TS 代码编译的结果，并且在文件级别是一一对应的。那么此时可以肯定，生成的 SourceMap 对应的源代码是 TS 编译后的 JS 代码，而不是 TS 代码。也就是说，tsconfig 的 sourceMap 没有生效？

令人啼笑皆非的是，重新去检查了一遍所有 tsconfig，发现原来是子项目中专门用于构建的 tsconfig 里关闭了 sourceMap 选项。

# 尾声

到此，这个问题也就解决了，同时我们也学会了一些关于 Debug 和 SourceMap 的知识。

然而，排除问题的过程其实并非上面描述的那么一帆风顺。其中涉及到的 NX 的编译构建过程的知识，还是现学的。说到底，正是因为不了解，所以才产生了问题，解决问题的过程，也就是学习的过程。

