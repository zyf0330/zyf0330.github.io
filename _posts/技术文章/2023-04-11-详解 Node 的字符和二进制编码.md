---
layout: post
title: 'è¯¦è§£ Node çš„å­—ç¬¦å’ŒäºŒè¿›åˆ¶ç¼–ç .md'
date: 2023-04-11
category: æŠ€æœ¯æ–‡ç« 
---

## å‰è¨€

æœ€è¿‘åšä¸€ä¸ªåŠŸèƒ½ï¼Œæ¶‰åŠåˆ°äº† Buffer å’Œ string ä¹‹é—´ç¼–è§£ç ã€‚è¿‡ç¨‹ä¸­å‘ç°è‡ªå·±å‡ ä¹å½»åº•é—å¿˜äº†ç›¸å…³çš„çŸ¥è¯†ï¼Œå› æ­¤æœ‰å¿…è¦è®°å½•åœ¨çº¸ä¸Šã€‚

> å¹´è½»çš„æ—¶å€™å–œæ¬¢æŠŠâ€œå…¬å¼â€è€Œä¸æ˜¯ç»“æœè®°åˆ°è„‘è¢‹é‡Œï¼Œä½†åˆ°è€äº†æ‰å‘ç°ï¼Œå³ä½¿è®°ä½äº†å…¬å¼ï¼Œä¹Ÿè®°ä¸ä½æ˜¯æ€ä¹ˆä¸²è”å…¬å¼æ¨å¯¼ç»“æœäº†ã€‚ğŸ¤”



## åŸºç¡€æ¦‚å¿µ

å¯¹ç¼–è§£ç æœ‰ç–‘æƒ‘ï¼Œå…«æˆæ˜¯æ²¡æœ‰æ­£ç¡®ç†è§£ Buffer å’Œ stringï¼Œå°¤å…¶æ˜¯ stringã€‚

åœ¨å‡†ç¡®ç†è§£å®ƒä»¬åï¼Œåº”è¯¥èƒ½é¡ºç†æˆç« çš„ææ¸…æ¥šç¼–è§£ç è¿™ä¸ªé—®é¢˜ã€‚

### ä»€ä¹ˆæ˜¯ Buffer

> æ–‡æ¡£   [https://nodejs.org/api/buffer.html#buffer](https://nodejs.org/api/buffer.html#buffer)  

Buffer ä»£è¡¨çš„æ˜¯ä¸€ä¸²å›ºå®šé•¿åº¦çš„å­—èŠ‚åºåˆ—ã€‚è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š

- ä¸€ä¸ªå­—èŠ‚ byte æ˜¯8ä½ bitï¼ŒèŒƒå›´æ˜¯ 00000000~11111111
- å›ºå®šé•¿åº¦æŒ‡ä¸€ä¸ª Buffer çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´é‡Œé¢èƒ½å¡å‡ ä¸ªå­—èŠ‚æ˜¯å›ºå®šä¸å˜çš„
- ä¸€ä¸²å­—èŠ‚åºåˆ—ï¼Œä¹Ÿå°±æ˜¯è¯´é‡Œé¢çš„å­—èŠ‚æ˜¯æœ‰é¡ºåºçš„è¿èµ·æ¥çš„




> Node çš„ Buffer æ˜¯ä¸èƒ½æŒ‰ä½æ“ä½œçš„



è‡³äº Buffer é‡Œé¢åˆ°åº•å¡äº†å“ªäº›å­—èŠ‚ï¼Œè¿™äº›å­—èŠ‚åˆä»£è¡¨ä»€ä¹ˆï¼Œå°±å…³ç³»åˆ°äº†ç¼–ç ï¼Œä¸‹é¢å†è®²



### ä»€ä¹ˆæ˜¯ character

character å°±æ˜¯å­—ç¬¦ã€‚

å­—ç¬¦æ˜¯å¯è§†ç¬¦å·ï¼Œå…·æœ‰ä¸€å®šçš„å½¢çŠ¶ï¼Œå¯ä»¥å‡­è‚‰çœ¼åŒºåˆ†ã€‚é€šä¿—åœ°è®²å°±æ˜¯äººçœ¼å¯è§‚å¯Ÿå¯è¯†åˆ«çš„é€šè¿‡å½¢æ€åŒºåˆ†çš„ç¬¦å·ã€‚æ¯ä¸ªä¸åŒçš„å­—ç¬¦æœ‰ä¸åŒçš„å«ä¹‰ã€‚

åœ¨è®¡ç®—æœºæœ¯è¯­ä¸­ï¼Œå­—ç¬¦å°±æ˜¯ä¸€ä¸ªå¯ä»¥æ¸²æŸ“åœ¨å±å¹•ä¸Šçš„ç¬¦å·ã€‚

åœ¨ JS ä¸­ï¼Œä¸å­˜åœ¨å­—ç¬¦ç±»å‹ï¼Œåªæœ‰å­—ç¬¦ä¸² string ç±»å‹ï¼Œå•ä¸ªå­—ç¬¦ä¹Ÿæ˜¯ä¸€ä¸ª stringï¼Œå¦‚   `'a'`    ã€‚



### ä»€ä¹ˆæ˜¯ string

string æ˜¯æ¯ä¸ªäººåœ¨åˆšå¼€å§‹å­¦ä¹ ç¼–ç¨‹è¯­è¨€æ—¶æœ€å…ˆæ¥è§¦çš„æ¦‚å¿µå’Œç±»å‹ä¹‹ä¸€ï¼ŒJS ä¸­çš„ string æ›´æ˜¯ä¸€ç§åŸºæœ¬ç±»å‹ï¼Œå› æ­¤å¾ˆå¤šäººå¯¹ string çš„ç†è§£å’Œè®¤çŸ¥éƒ½åœç•™åœ¨åˆè¯†æ—¶ï¼Œä½† string å…¶å®ä¸æ˜¯é‚£ä¹ˆçš„ç®€å•ã€‚

è­¬å¦‚å½“æˆ‘é—®ï¼Œjs ä¸­çš„ string æ˜¯ä»€ä¹ˆç¼–ç ï¼Œæ˜¯ utf8 ç¼–ç å—ï¼Ÿå¯èƒ½æœ‰å¾ˆå¤šäººçŠ¹ç–‘ä¸å®šã€‚

æ­£æ˜¯å› ä¸ºå¾ˆå¤šäººå¯¹ string çš„æ¦‚å¿µä¸æ¸…æ™°ï¼Œè¦ä¹ˆå‹æ ¹ä¸çŸ¥é“ï¼Œè¦ä¹ˆæ˜¯æŠŠ string å’Œ   `Buffer.toString`  æåˆ°çš„ç¼–ç æ··æ·†ï¼Œæ‰ä¼šç–‘æƒ‘ã€‚



JS çš„ string ä»£è¡¨çš„æ˜¯ä¸€ä¸²å­—ç¬¦åºåˆ—ï¼Œä½¿ç”¨ utf16(æˆ– ucs-2) ç¼–ç ï¼Œè€Œ V8 å¼•æ“å®ç°ä½¿ç”¨çš„æ˜¯ utf16le ç¼–ç ã€‚è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š

- å­—ç¬¦ï¼šå°±æ˜¯ä¸Šé¢çš„ character å­—ç¬¦
- ä¸€ä¸²åºåˆ—ï¼Œä¹Ÿå°±æ˜¯è¯´é‡Œé¢çš„å­—ç¬¦ä»¬æ˜¯æœ‰é¡ºåºçš„è¿èµ·æ¥çš„
- ç¼–ç 
    - å­—ç¬¦æœ¬èº«çš„ç ç‚¹ code pointï¼šæ ¹æ® Unicode æ ‡å‡†ï¼Œä¸€ä¸ªå­—ç¬¦å¯¹åº”ä¸€ä¸ªæ•°å­—ï¼Œå¦‚ ğŸ˜ å¯¹åº”   U+1F60E   ä¹Ÿå°±æ˜¯ 128526ï¼Œ  `'ğŸ˜'.codePointAt(0) === 128526`  
    - è¯¥ç ç‚¹çš„äºŒè¿›åˆ¶ç¼–ç ï¼šutf16 æ˜¯å°† Unicode ç ç‚¹æ˜ å°„åˆ°å­—èŠ‚è¡¨ç¤ºçš„ç¼–ç è§„åˆ™ï¼Œå­—èŠ‚åºåˆ—ä¸­æ¯ä¸¤ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªç å…ƒ code unit(char code)
    - å› æ­¤ JS çš„ string åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºï¼Œå°±æ˜¯å°†è¾“å…¥çš„å­—ç¬¦åºåˆ—å¯¹åº”çš„ç ç‚¹æ ¹æ® utf16 ç¼–ç è§„åˆ™å˜æˆçš„å­—èŠ‚åºåˆ—ã€‚å¦‚ ğŸ˜ å¯¹åº”çš„ 128526 æ ¹æ® utf16le(little endian)  ç¼–ç ä¸º   `3D D8 0E DE`  å…±å››ä¸ªå­—èŠ‚


```
Buffer.from([parseInt('3d', 16),parseInt('d8', 16),parseInt('0e', 16),parseInt('de', 16)]).toString('utf16le') === 'ğŸ˜'
'\ud83d\ude0e' === 'ğŸ˜' // C/Java style notation
'ğŸ˜'.charCodeAt(0ï¼‰=== 55357 === parseInt('d83d', 16)
'ğŸ˜'.charCodeAt(1) === 56846 === parseInt('de0e', 16)
```



çœ‹åˆ°è¿™é‡Œï¼Œä½ åº”è¯¥æ˜ç™½äº†ï¼ŒJS çš„ string ä½¿ç”¨ utf16 ç¼–ç æ˜¯ä»€ä¹ˆæ„æ€



## å­—ç¬¦ç¼–ç 

ä¸Šé¢ string éƒ¨åˆ†å·²ç»æåŠäº†ä¸€äº›ç¼–ç ç›¸å…³çš„å†…å®¹ï¼Œè¿™èŠ‚æ±‡æ€»è®¨è®ºä¸€ä¸‹å­—ç¬¦ç¼–ç ã€‚

> ç”±äºå­—ç¬¦ä¸²æ˜¯å­—ç¬¦ç»„æˆçš„ï¼Œæ‰€ä»¥å½“è°ˆåˆ°å­—ç¬¦ä¸²ç¼–ç å°±æ˜¯æŒ‡å­—ç¬¦ç¼–ç ã€‚



æ—¥å¸¸æˆ‘ä»¬å¯¹ string çš„ä½¿ç”¨åœºæ™¯ï¼ŒåŸºæœ¬éƒ½æ˜¯ä½¿ç”¨å¼•å·æˆ–   `String`  æ„é€ å™¨å°†ä¸€ä¸²å­—ç¬¦å¡«å…¥ï¼Œæ¥å£°æ˜ä¸€ä¸ªæ‰€è°“çš„ stringï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ª string æ¥é€šè¿‡   `console.log`  æ˜¾ç¤ºåœ¨ç»ˆç«¯é‡Œã€ä¿å­˜åˆ°æ•°æ®åº“å†å–å‡ºæ¥ã€é€šè¿‡ http å“åº”è¿”å›ç»™å‰ç«¯ç­‰ç­‰ï¼Œåœ¨ debug ç•Œé¢ã€åœ¨ç»ˆç«¯é‡Œã€åœ¨ç½‘é¡µä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°çš„æ˜¯æˆ‘ä»¬è¾“å…¥çš„é‚£äº›å­—ç¬¦ã€‚è¿™äº›å­—ç¬¦ï¼Œæœ‰è‹±æ–‡æœ‰ä¸­æ–‡æœ‰ emojiï¼Œéƒ½å±äº Unicode ç¼–ç èŒƒå›´ã€‚

æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œstringã€æˆ–è€…è¯´æ˜¯ç¼–ç¨‹è¯­è¨€å£°æ˜çš„ä¸€åˆ‡ï¼Œåœ¨è¿è¡Œæ—¶éƒ½æ˜¯å­˜åœ¨åœ¨å†…å­˜ä¸­ã€åœ¨ç½‘ç»œè¯·æ±‚ä¼ è¾“ç®¡é“ä¸­ï¼Œè€Œè¿™é‡Œåªæœ‰äºŒè¿›åˆ¶ bit å’Œå­—èŠ‚ Byteã€‚



æ€»çš„æ¥è¯´ï¼Œè®¡ç®—æœºé¢†åŸŸä¸­çš„å­—ç¬¦ç¼–ç ï¼Œå°±æ˜¯å°†å­—ç¬¦åºåˆ—çš„ Unicode ç¼–ç é€šè¿‡æŸç§è§„åˆ™å˜ä¸ºå¯ä»¥ç”¨å­—èŠ‚ï¼ˆäºŒè¿›åˆ¶ï¼‰åºåˆ—è¡¨ç¤ºçš„å½¢å¼ï¼Œå¯¹åº”çš„è§£ç å°±æ˜¯åè¿‡æ¥çš„æ“ä½œã€‚



å¸¸è§çš„å­—ç¬¦ç¼–ç æœ‰ä¸‹é¢è¿™ä¹ˆå‡ ç§ï¼Œå…¶ä¸­æœ‰äº›æ˜¯ Node å†…å»ºæ”¯æŒçš„ï¼š

- utf8ï¼šæ¯ä¸ª Unicode å­—ç¬¦è½¬æ¢ä¸ºä¸å®šé•¿çš„å­—èŠ‚åºåˆ—
- utf16ï¼šæ¯ä¸ª Unicode å­—ç¬¦è½¬æ¢ä¸º2æˆ–4å­—èŠ‚çš„å®šé•¿åºåˆ—ï¼Œå…¶ä¸­è¿˜åŒºåˆ†ç«¯åº LE å’Œ BEï¼ŒNode æ”¯æŒçš„æ˜¯ utf16le
- latin1ï¼šåªè¦†ç›–0-255 èŒƒå›´çš„ Unicode å­—ç¬¦ï¼Œå­—èŠ‚åºåˆ—ä¸º1å­—èŠ‚é•¿åº¦
- asciiï¼šè¦†ç›–0-127 èŒƒå›´çš„å­—ç¬¦ï¼Œ7ä½é•¿åº¦ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œä¸€èˆ¬å æ®ä¸€ä¸ªå­—èŠ‚æ¥å­˜æ”¾
- GB2312, GBK, GB18030ï¼šä¸­å›½æ ‡å‡†å­—ç¬¦é›†å’Œç¼–ç ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç®—æ˜¯ Unicode å­—ç¬¦é›†çš„å­é›†ï¼Œä½†ç¼–ç è§„åˆ™å’Œ UTF ç³»åˆ—ä¸å…¼å®¹ï¼Œå°±ä¸è¯¦ç»†è¯´æ˜äº†


> å†·çŸ¥è¯†ï¼šæœ‰çš„åœ°æ–¹â€”â€”æœ‰çš„è¯­è¨€ã€æœ‰çš„ç¯å¢ƒï¼Œä¸€ä¸ªå­—èŠ‚é•¿åº¦ä¸æ˜¯8ä½



### Node çš„å­—ç¬¦ç¼–è§£ç 

ç¨‹åºå’Œå¤–éƒ¨ï¼ˆç½‘ç»œã€ç£ç›˜æ–‡ä»¶ç­‰ï¼‰é€šä¿¡éƒ½æ˜¯é€šè¿‡äºŒè¿›åˆ¶ï¼Œå½“è¦å°†å­—ç¬¦é€åˆ°ç¨‹åºå¤–éƒ¨æ—¶ï¼Œéœ€è¦ç¼–ç ï¼Œåä¹‹ä»å¤–éƒ¨æ¥æ”¶æ—¶éœ€è¦è§£ç ã€‚

è¿™é‡Œç”¨ utf8 ç¼–ç ä¸¾ä¸ªä¾‹å­ï¼Œçœ‹çœ‹å­—ç¬¦ç¼–è§£ç åˆ°åº•æ˜¯æ€ä¹ˆä¸ªè¿‡ç¨‹ï¼š

- è§£ç  decode æˆ–ç§°ä¹‹ä¸ºååºåˆ—åŒ– deserialize
-     1. ä»å¤–éƒ¨æ¥æ”¶åˆ°çš„äºŒè¿›åˆ¶æ”¾åœ¨ Buffer ä¸­
    1. ä½¿ç”¨   `Buffer.prototype.toString('utf8')`  å°† buffer å˜æˆ string
        1. å°† buffer ä¸­çš„å­—èŠ‚æ ¹æ® utf8 ç¼–ç è§„åˆ™ï¼Œè½¬æ¢ä¸º Unicode å­—ç¬¦
        1. å†æ„é€  stringï¼šå°†å­—ç¬¦æ ¹æ® utf16 ç¼–ç è§„åˆ™è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—ï¼Œç”Ÿæˆå¯¹åº”çš„ string

- ç¼–ç  encode æˆ–ç§°ä¹‹ä¸ºåºåˆ—åŒ– serialize
-     1. è¦æŠŠ string ä¼ é€å‡ºå»ï¼Œæ¯”å¦‚ http response çš„   `write(buffer: Buffer)`  
    1. ä½¿ç”¨   `Buffer.from(string, 'utf8')`  å°† string å˜æˆ buffer
        1. å°† string ä¸­çš„å­—èŠ‚åºåˆ—æ ¹æ® utf16 ç¼–ç è§„åˆ™è½¬æ¢ä¸º Unicode å­—ç¬¦
        1. å°† Unicode å­—ç¬¦æ ¹æ® utf8 ç¼–ç è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—ï¼Œæ”¾å…¥ buffer





å…¶ä»–ç¼–ç ä¹Ÿæ˜¯ä¸€æ ·çš„è¿‡ç¨‹ï¼Œå¯¹äº Node åŸç”Ÿä¸æ”¯æŒçš„ç¼–ç ï¼Œä¹Ÿæœ‰ç¬¬ä¸‰æ–¹åº“å¯ä»¥ä½¿ç”¨ã€‚



## äºŒè¿›åˆ¶ç¼–ç 

æœ‰äººå¯èƒ½ä¼šç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆä¸Šé¢æ²¡æœ‰æåˆ° Buffer encoding çš„ base64, hex ç­‰ç¼–ç ï¼Œè¿™æ˜¯å› ä¸ºè¿™äº›ç¼–ç ä¸æ˜¯ç”¨æ¥å¯¹å­—ç¬¦ï¼Œè€Œæ˜¯å¯¹äºŒè¿›åˆ¶ç¼–ç çš„ï¼Œå®ƒä»¬å°†äºŒè¿›åˆ¶åºåˆ—ç¼–ç ä¸ºå­—ç¬¦ã€‚

éœ€è¦å¯¹äºŒè¿›åˆ¶ç¼–ç çš„ç†ç”±æ˜¯ï¼Œä¸ºäº†ä½¿å¾—äºŒè¿›åˆ¶åºåˆ—ä¿¡æ¯èƒ½é€šè¿‡æœ¬æ¥ä¸ºæ™®é€šå­—ç¬¦ä¼ è¾“å»ºç«‹çš„é€šé“ï¼Œè¿™äº›é€šé“æœ‰æµè§ˆå™¨ç½‘é¡µã€é‚®ä»¶ã€urlã€å„ç§èŠå¤©å·¥å…·ç­‰ç­‰ï¼Œä¸Šé¢å‘ˆç°çš„å­—ç¬¦æ— ä¸€ä¾‹å¤–éƒ½æ˜¯å¯ä»¥è¢«äººçœ¼è¯†åˆ«å’Œæ‰‹æŠ„çš„ã€‚

ç”±äºå‡ ä¹æ‰€æœ‰çš„å¸¸è§é€šé“çš„å­—ç¬¦è½½ä½“éƒ½æ”¯æŒ ascii ç¼–ç ï¼Œæ‰€ä»¥ base64, hex ç­‰ç¼–ç çš„ç»“æœï¼Œéƒ½æ˜¯ ascii å­—ç¬¦ã€‚ä½† url è¿™ä¸ªè½½ä½“æ˜¯ä¸ªä¾‹å¤–ï¼Œurl æ”¯æŒçš„å­—ç¬¦é›†æ¯” ascii æ›´å°‘ï¼ˆæ—  + /ï¼‰ï¼Œæ‰€ä»¥æœ‰ base64url ç­‰ç¼–ç ï¼Œç¼–ç ç»“æœé€‚ç”¨äºåœ¨ url ä¸­æºå¸¦ã€‚

### Node çš„äºŒè¿›åˆ¶ç¼–è§£ç 

äºŒè¿›åˆ¶ç¼–è§£ç å’Œå­—ç¬¦ç¼–è§£ç è¿‡ç¨‹æ˜¯åç€çš„

ä¸‹é¢ç”¨ base64 ç¼–ç ä¸¾ä¾‹ï¼Œçœ‹çœ‹äºŒè¿›åˆ¶ç¼–è§£ç æ˜¯æ€ä¹ˆä¸ªè¿‡ç¨‹ï¼š

- è§£ç  decode æˆ–ç§°ä¹‹ä¸º parse
-     1. ä»å¤–éƒ¨æ¥æ”¶åˆ°äº† base64 ç¼–ç çš„ string
    1. ä½¿ç”¨   `Buffer.from(string, 'base64')`  å°† string å˜æˆ buffer
        1. æ ¹æ® utf16 ç¼–ç è§„åˆ™å°† string å†…å­˜æ”¾çš„å­—èŠ‚åºåˆ—è½¬æ¢ä¸º ascii å­—ç¬¦
        1. æ ¹æ® base64 ç¼–ç è§„åˆ™å°†å­—ç¬¦è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—å­˜æ”¾åˆ° buffer ä¸­

- ç¼–ç  encode æˆ–ç§°ä¹‹ä¸º stringify
-     1. è¦å°† buffer ä¼ é€å‡ºå»ï¼Œæ¯”å¦‚ http response çš„   `write(string: String, encoding)`  
    1. ä½¿ç”¨   `Buffer.prototype.toString('base64')`  å°† buffer å˜ä¸º string
        1. å°† buffer ä¸­çš„å­—èŠ‚åºåˆ—æ ¹æ® base64 ç¼–ç è§„åˆ™è½¬æ¢ä¸º ascii å­—ç¬¦
        1. å†æ„é€  stringï¼šæ ¹æ® utf16 ç¼–ç å°† ascii å­—ç¬¦è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—ï¼Œç”Ÿæˆå¯¹åº”çš„ string
    1.   `write`   å†…éƒ¨å°†ä¼ å…¥çš„ string æ ¹æ®æŒ‡å®š encoding è¿›è¡Œå­—ç¬¦ç¼–ç ä¸º buffer åé€å‡º





## åè¯­

å¤ªå¤æ‚äº†ï¼Œè¿‡ä¸€ä¸ªæœˆä»¥åä¸€å®šä¼šå¿˜å¾—å¹²å¹²å‡€å‡€ã€‚ã€‚ã€‚



## æ‰©å±•é˜…è¯»

> ä¸€ç¯‡è¯¦ç»†çš„æ¢ç©¶ JS string ç¼–ç çš„æ–‡ç« ï¼Œä» Unicode åˆ° ECMAScript è§„èŒƒåˆ° JS å¼•æ“å®ç°     [https://mathiasbynens.be/notes/javascript-encoding](https://mathiasbynens.be/notes/javascript-encoding)  

> Node å…³äº Buffer å­—ç¬¦ç¼–ç çš„æ–‡æ¡£   [https://nodejs.org/api/buffer.html#buffers-and-character-encodings](https://nodejs.org/api/buffer.html#buffers-and-character-encodings)  

