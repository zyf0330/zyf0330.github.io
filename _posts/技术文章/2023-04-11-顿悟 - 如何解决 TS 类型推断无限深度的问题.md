---
layout: post
title: '顿悟 - 如何解决 TS 类型推断无限深度的问题.md'
date: 2023-04-11
category: 技术文章
---

## 前言

这次内容主要涉及：

1. Query Builder 作为一个基础模块的功能迭代历史
1. 每个阶段我对 TS 认识的变化过程


## 背景

最近在重构   [Query Builder](http://lib.worktile.live/chaos/guides/modules/query-builder)   的类型系统，为了使   `field`  方法支持带数组索引的参数。这次重构结果是非常成功的，不仅支持了数组索引，还使参数类型  `KeyChains`  支持任意深度的键链。


但这不是今天要讲的重点，今天要讲的重点是，在这次重构过程中，我顿悟了如何避免 TS 类型函数报类似   `Type instantiation is excessively deep and possibly infinite`   的错误。

我想先讲讲顿悟产生的历程。而这个问题具体的技术细节放到最后，因为它本身很简单。

## 顿悟的历程

关注的人可能知道，Query Builder 是我在去年5月开始出于个人兴趣做的。

那时我刚入职5天，Typhon 是我第二个接触的 TS 项目，在那之前我做的项目还主要是 JS 语言。在写 Typhon 的查询条件构造代码时，我为必须手动去 Entity 中查找和复制字段名而烦，我都已经在写 TS 了为什么还不能自动推断出字段名呢？！

有了之前一个项目的铺垫，再加上那几天通过 Typhon TS 代码产生的认识，我对于 TS 类型系统能具备的能力已经有了大概的了解。所以我决定写个工具来实现自动推断字段名（我那时叫它 Condition Builder）

**这个阶段，我对于 TS 的认识，是结合了很久以前对于 Java 类型系统的了解，产生的应用层面的认识。只是尝试学习和使用了一些 TS 类型语法，并没有更深刻的认识。**



做完第一版之后，于去年11月它被放入 chaos 作为一个模块，改名 Query Builder，由于 Mongo 官方文档中这个东西的名称就是 Query。

> 但要是知道 pc-core 中已经有一个 (Property) Query Builder，我一定会叫它 MongoQueryBuilder 以避免混淆

当时它设计中该有的功能都有了，但是尚存一些使用上的不便和瑕疵（当然还有一些隐藏的 bug）。其中最大的，就是设置字段的参数不是 Mongo dot-notation 形式如   `a.b.c`  ，而是   `['a', 'b', 'c']`  。这样写起来不仅麻烦，更重要的是，这不是习惯的原生的书写内嵌字段名的方式。毫无疑问这会使大家不喜欢使用它，即使它能提供类型安全。

因此在去年12月初，我改写了类型系统，支持了   `dot-notation`  的参数形式——  **有限的**  。有限在它不支持带数组索引的字段名如   `a.0.b`  ，还只能支持固定深度的字段（当时我设置为3）。好歹这对于平常业务也够用了。

**这个阶段， 是我第二次尝试深入学习和使用 TS 类型系统。但深度基本还停留在上个阶段的层次。学会了一些 trick，可以写出更多的花活，但是也没有产生更深的领悟。**



在那之后，我选择放松一段时间，偏向于在日常业务中使用和推广 Query Builder，看它是否可用和好用。当然了，这期间修复了一些 bug，也进行了一些功能改善和增强。但是，我始终没有忘记它的字段名支持还是残缺的，我得使它完整。

这期间，我也多次尝试搜索相关问题的答案，看 TS Github 的相关 issue，对递归类型函数有了更多的认识。  **在此时，我已经意识到了**  `type`  ** 就是个函数，运行在编译期。但是我没有将这一认识贯彻。**

到了今年4月，我得了一些空，决定再次尝试改进类型系统，解决掉余下的问题。这次我直接从头开始写各个类型函数，比较顺利。然后我把新写的函数替换掉旧的，保持定义和功能不变。然而，熟悉的错误再次出现了。

百般调试之后，我还是没能彻底解决这个问题。但预期的效果已经达到了，字段名支持了数组索引，并且深度够大，只是数组索引最大只能支持到9。因此我让   `Integer`  类型只支持到最大9，然后准备提交 PR 了。看来我的功力还不够。

不过，昨晚躺下的时候，我无意中开始思索这个问题，“递归类型函数报错类型实例化太深 deep”，  **递归、函数、太深**  ，我突然反应过来，我是不是傻，怎么没意识到这就是个  **递归函数该用尾递归优化**  的问题。

**此时此刻，我基本上已经彻底领悟了 TS 的类型函数的工作方式。不再是之前浅显的基于认识的层面。**

## 总结

这篇偏技术的东西少，更多的是讲从学习技术到领悟技术再到掌握技术，这期间每一阶段经历的总结。

在挣扎中前进，厚积薄发，这是我本人最常用的成长方式。希望对大家也有所借鉴。



## 如何解决 TS 类型推断无限深度的问题

最后把开头的问题解决了。很简单，关键就是两点：

1. 认识到，类型函数也是个函数，只是运行在编译期间。比如编译时的 tsc 中，或开发时在 TS Language Service 中。
1. 然后利用大家应该都会的——  [尾递归优化](https://www.ruanyifeng.com/blog/2015/04/tail-call.html)  

