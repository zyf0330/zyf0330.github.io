---
layout: post
title: 'BSON 编解码器的坑.md'
date: 2023-06-07
category: 技术文章
---

最近在做一件惠及各位服务端开发的事，就是让   `Id`  的程序类型在 RPC 传输过程中正确保留，以免 RPC 服务端需要手动解析它。

由于目前   `Id`  的唯一实现就是 BSON 的   `ObjectID`  ，那么改用 BSON 编解码器来做这个支持，是自然而然的想法。

然而在 chaos 的改动发版上线后，发现了两个大坑，导致这个解决方案根本无法使用，并且紧急撤回了 chaos 的发版。

下面看看这两个大坑是什么吧。



#### 坑1：自定义类不能正确序列化

一个比较普遍的例子是   `MongoDBId`  。

我们使用   `MongoDBId`  对   `ObjectID`  做了一层封装，来作为   `Id`  的实现。然而经过 BSON 序列化之后，它变成了一个空对象（如图）。经过检查，它是在序列化后丢失的信息。

![](../attachments/BSON%20编解码器坑1.png)

#### 坑2：数组被转换为对象，且 undefined 变为 null

这里包含两部分。

1. 数组被转换为了对象，这导致数组本身具有的方法或能力都无法被调用，比如   `slice`  或   `Array.prototype[@@iterator]`  。
1. undefined 被转换为 null，这导致在将对应值应用到函数参数上时，无法正确触发函数的可选参数机制。

![](../attachments/BSON%20编解码器坑2.png)


后续我们会采用一种更为保守的方法，在原有的 JSON 编解码器上扩展对   `Id`  的支持，作为新的解决方案。

